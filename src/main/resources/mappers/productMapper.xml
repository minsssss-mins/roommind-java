<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.roomgenius.furniture_recommendation.mapper.ProductMapper">

    <!-- 상품 등록 -->
    <insert id="insertProduct"
            parameterType="com.roomgenius.furniture_recommendation.entity.ProductDTO"
            useGeneratedKeys="true"
            keyProperty="productId">

        INSERT INTO Product (
        category_id,
        product_name,
        brand,
        original_price,
        sale_price,
        stock,
        description
        )
        VALUES (
        #{categoryId},
        #{productName},
        #{brand},
        #{originalPrice},
        #{salePrice},
        #{stock},
        #{description}
        )
    </insert>


    <!-- 상품 이미지 삽입 -->
    <insert id="insertProductFile">
        INSERT INTO File (
        uuid,
        product_id,
        save_dir,
        file_name,
        file_size
        )
        VALUES (
        UUID(),
        #{productId},
        #{saveDir},
        #{fileName},
        #{fileSize}
        )
    </insert>


    <!-- ⭐ 전체 상품 조회 -->
    <select id="selectAllProducts" resultType="com.roomgenius.furniture_recommendation.entity.ProductVO">
        SELECT
        p.product_id     AS productId,
        p.category_id    AS categoryId,
        p.product_name   AS productName,
        p.brand          AS brand,
        p.original_price AS originalPrice,
        p.sale_price     AS salePrice,
        p.stock          AS stock,
        p.description    AS description,
        p.created_date   AS createdDate,
        p.updated_date   AS updatedDate,

        -- 첫 번째 이미지 1장 URL
        CASE
        WHEN f.save_dir IS NOT NULL THEN
        CONCAT(
        '/',
        SUBSTRING(f.save_dir, LOCATE('uploads', f.save_dir)),
        '/',
        f.file_name
        )
        ELSE NULL
        END AS imageUrl

        FROM Product p

        LEFT JOIN (
        SELECT
        f.*
        FROM File f
        INNER JOIN (
        SELECT product_id, MIN(uuid) AS min_uuid
        FROM File
        GROUP BY product_id
        ) x ON f.product_id = x.product_id AND f.uuid = x.min_uuid
        ) f ON p.product_id = f.product_id

        ORDER BY p.product_id DESC
    </select>



    <!-- ⭐ 단일 상품 조회 -->
    <select id="getProductById"
            parameterType="int"
            resultType="com.roomgenius.furniture_recommendation.entity.ProductVO">

        SELECT
        p.product_id     AS productId,
        p.category_id    AS categoryId,
        p.product_name   AS productName,
        p.brand          AS brand,
        p.original_price AS originalPrice,
        p.sale_price     AS salePrice,
        p.stock          AS stock,
        p.description    AS description,
        p.created_date   AS createdDate,
        p.updated_date   AS updatedDate,

        CASE
        WHEN f.save_dir IS NOT NULL THEN
        CONCAT(
        '/',
        SUBSTRING(f.save_dir, LOCATE('uploads', f.save_dir)),
        '/',
        f.file_name
        )
        ELSE NULL
        END AS imageUrl

        FROM Product p
        LEFT JOIN (
        SELECT
        f.*
        FROM File f
        INNER JOIN (
        SELECT product_id, MIN(uuid) AS min_uuid
        FROM File
        GROUP BY product_id
        ) x ON f.product_id = x.product_id AND f.uuid = x.min_uuid
        ) f ON p.product_id = f.product_id

        WHERE p.product_id = #{productId}
    </select>


    <!-- ⭐ 단일 상품 삭제 -->
    <delete id="deleteProductById" parameterType="int">
        DELETE FROM Product
        WHERE product_id = #{productId}
    </delete>

    <!-- ⭐ 상품 수정 -->
    <update id="updateProduct"
            parameterType="com.roomgenius.furniture_recommendation.entity.ProductDTO">

        UPDATE Product
        SET
        category_id = #{categoryId},
        product_name = #{productName},
        brand = #{brand},
        original_price = #{originalPrice},
        sale_price = #{salePrice},
        stock = #{stock},
        description = #{description},
        updated_date = NOW()
        WHERE product_id = #{productId}

    </update>

</mapper>
