<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.roomgenius.furniture_recommendation.mapper.CategoryMapper">

    <!-- =============================== -->
    <!-- 전체 조회 (정렬 적용) -->
    <!-- =============================== -->
    <select id="selectAllCategories"
            resultType="com.roomgenius.furniture_recommendation.entity.CategoryVO">

        SELECT
        category_id     AS categoryId,
        major_category  AS majorCategory,
        middle_category AS middleCategory,
        sort_order      AS sortOrder,
        created_date    AS createdDate,
        updated_date    AS updatedDate
        FROM Category
        ORDER BY
        major_category ASC,
        sort_order ASC

    </select>


    <!-- =============================== -->
    <!-- 단일 조회 -->
    <!-- =============================== -->
    <select id="getCategoryById"
            parameterType="int"
            resultType="com.roomgenius.furniture_recommendation.entity.CategoryVO">

        SELECT
        category_id     AS categoryId,
        major_category  AS majorCategory,
        middle_category AS middleCategory,
        sort_order      AS sortOrder,
        created_date    AS createdDate,
        updated_date    AS updatedDate
        FROM Category
        WHERE category_id = #{categoryId}

    </select>


    <!-- =============================== -->
    <!-- 카테고리 이름 조회 -->
    <!-- =============================== -->
    <select id="getCategoryName"
            parameterType="int"
            resultType="string">

        SELECT CONCAT(major_category, ' > ', middle_category)
        FROM Category
        WHERE category_id = #{categoryId}

    </select>


    <!-- =============================== -->
    <!-- 정렬용: 해당 대분류의 MAX(sort_order) 조회 -->
    <!-- =============================== -->
    <select id="getMaxSortOrder"
            parameterType="string"
            resultType="int">

        SELECT IFNULL(MAX(sort_order), 0)
        FROM Category
        WHERE major_category = #{majorCategory}

    </select>


    <!-- =============================== -->
    <!-- 등록 -->
    <!-- =============================== -->
    <insert id="insertCategory"
            parameterType="com.roomgenius.furniture_recommendation.entity.CategoryVO"
            useGeneratedKeys="true"
            keyProperty="categoryId">

        <selectKey keyProperty="sortOrder" resultType="int" order="BEFORE">
            SELECT IFNULL(MAX(sort_order), 0) + 1
            FROM Category
            WHERE major_category = #{majorCategory}
        </selectKey>

        INSERT INTO Category
        (major_category, middle_category, sort_order)
        VALUES
        (#{majorCategory}, #{middleCategory}, #{sortOrder})

    </insert>


    <!-- =============================== -->
    <!-- 수정 -->
    <!-- =============================== -->
    <update id="updateCategory"
            parameterType="com.roomgenius.furniture_recommendation.entity.CategoryVO">

        UPDATE Category
        SET
        major_category = #{majorCategory},
        middle_category = #{middleCategory},
        updated_date = NOW()
        WHERE category_id = #{categoryId}

    </update>


    <!-- =============================== -->
    <!-- 삭제 -->
    <!-- =============================== -->
    <delete id="deleteCategory"
            parameterType="int">

        DELETE FROM Category
        WHERE category_id = #{categoryId}

    </delete>


    <!-- =============================== -->
    <!-- 정렬 업데이트 -->
    <!-- =============================== -->
    <update id="updateOrder">
        UPDATE Category
        SET sort_order = #{sortOrder}
        WHERE category_id = #{categoryId}
    </update>

</mapper>
